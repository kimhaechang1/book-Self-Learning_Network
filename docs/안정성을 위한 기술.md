## 가용성

우선 안정성이란 특정 기능을 `균등한 성능`으로 제공할 수 있는 특성을 의미한다.

가용성은 안정성을 `수치화` 한 것으로 즉 특정 기능을 `균등한 성능`으로 제공할 수 있는 `시간의 비율`을 의미한다.

서비스의 전체 시간 = 실제로 기능 수행이 가능한 시간(업타임) + 기능 수행이 불가능한 시간(다운타임) 이 된다.

여기서 다운타임은 서버 점검등이 사유가 될 수 있다.

그래서 가용성은 다음과 같은 수식으로 표현할 수 있다.

```
가용성 = 업타임 / 전체 시간
```

그러면 자연스럽게 고가용성이 어떤말인지 알 수 있다.

흔히 9가 몇개 있는지에 따라 표기하며, 흔히 `안정적`이라고 표기하는것은 `가용성`이 `99.99999%` 인 시스템을 의미한다.

## 이중화와 다중화

가용성 계산에 있어서 다운타임은 사실 변수가 상당히 많다.(과도한 트래픽, 소프트웨어, 하드웨어적인 오류 등)

그래서 다운타임이 발생 하더라도 서비스가 중단되지 않는 `결함 감내`를 수행할 수 있어야 한다.

이를 만족하기 위해, 서비스내에서 "`이 소프트웨어 혹은 하드웨어 혹은 시스템이 중단될때 전체 서비스에 영향이 가는 지점`"인 `SPoF`를 찾고 

이 SPoF에 대한 백업본을 마련해놓는것이 `결함 감내`를 수행하는 방법이다.

여기서 백업본을 만들어놓는 개수에따라 `이중화`와 `다중화`로 나뉜다.

이중화의 기술에는 다음의 두가지가 있다.

- 액티브/액티브 방식

    - 두 복제서버를 둘다 가동시켜놓는것, 이는 부하를 분산시킬 수 있는 장점이 있지만, 적절한 알고리즘을 사용하지 못하면 부하가 집중될 가능성이 있음

- 액티브/스탠바이 방식

    - 하나의 서버만 가동시켜놓고 반대쪽은 대기상태로 두는것, 성능상의 이점은 없다.


위의 방식의 사례로 `티밍`혹은 `본딩`이 있다.

NIC를 이중화/다중화 하는것으로 묶어서 논리적으로 하나의 NIC로서 사용하는 방식이다.

## 로드 밸런싱

위의 이중화 다중화를 통해 SPoF를 막는것은 이제 성공적이다.

다음으로는 트래픽을 다중화 혹은 이중화(액티브/액티브)된 서비스에 올바르게 분배해야 한다.

`트래픽`이란 `어떤 시점에 해당 노드를 통과한 패킷의 양`을 의미한다.

이러한 트래픽을 복제된 서버들에게 `분배`하는 것을 `로드 밸런싱` 이라고 하고, (`load`: 부하)

분배하는 역할을 수행하는 소프트웨어 혹은 하드웨어를 `로드 밸런서` 라고 한다.

하드웨어 장비로는 `L4 스위치`, `L7 스위치`가 있고, 소프트웨어로는 `Nginx`가 있다.

### L4스위치와 L7스위치

<a href="https://etloveguitar.tistory.com/136">참고자료</a>

<a href="https://seungbae.oopy.io/91b34200-a9a6-4aeb-aa05-a350a8ecf61f">참고자료2</a>

<a href="https://www.stevenjlee.net/2020/06/30/%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-%EB%84%A4%ED%8A%B8%EC%9B%8C%ED%81%AC%EC%9D%98-%EB%B6%80%ED%95%98%EB%B6%84%EC%82%B0-%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%8B%B1-load-balancing-%EA%B7%B8/">참고자료 3</a>

먼저 L4스위치는 전송계층까지의 정보를 가지고 부하 분산을 하기 때문에, IP와 Port를 기준으로 아래의 부하분산 알고리즘을 통해 분산시킨다.

L7스위치는 응용계층까지의 정보를 가지고 있기 때문에 L4스위치보다 좀더 세밀한 패킷분석이 가능하다.

L7스위치는 IP, Port 이외에도 URI, Payload, Http Header, Cookie등의 내용을 기준으로 분산시킬 수 있다.

L4스위치는 따라서 L7스위치에서 만큼의 패킷 디캡슐화가 필요없기 때문에 속도는 빠르지만, 사용자의 IP가 자주 바뀌면 연속적인 서비스를 제공하기 힘들다.

L7스위치는 URI에 따른 로드벨런싱도 가능할정도로 세밀한 조정이 가능하지만, 그에 따른 추가 비용이 발생할 수 있다.

### 로드 밸런싱 알고리즘

로드 밸런싱을 수행하려면 일단 분배에 대한 적절한 알고리즘이 있어야 한다.

없으면 복제된 서버는 많은데 다른 서버들이 놀 수 있기 때문이다.

- 라운드 로빈 알고리즘

    - 서버를 돌면서 부하를 전달하는 알고리즘

    - 가중치가 추가되면 `가중치가 있는 라운드 로빈 알고리즘` 이 된다.

        - 가중치가 높은곳에 더 많이 트래픽을 부여하므로, 서버들의 스펙차이가 있을때 사용한다.

- 최소 연결 알고리즘

    - 연결이 적은 서버부터 부하를 전달하는 알고리즘

    - 새로운 연결이 발생할 때 마다 부하상태를 계산해야 하는 단점이 있음

- IP 해시

    - 동일한 IP를 가지면 해시알고리즘을 통해 동일한 서버에 트래픽을 분배한다.

    - 특정 서버로 트래픽이 집중될 수 있다.


위의 알고리즘에서 L7스위치의 경우 아래의 추가적인 알고리즘이 사용가능하다.

- 콘텐츠 기반 라우팅

    - HTTP 패킷을 분석하여 특정 콘텐츠 내용에 따라 트래픽을 적절한 서버로 분배하는 방식 

        - URI나 HTTP 헤더 그리고 Cookie 등을 분석하여 처리


### 포워드 프록시와 리버스 프록시

<a href="https://www.youtube.com/watch?v=JqCgJI-Nk88">테코톡: 포워드 프록시, 리버스 프록시, 로드 밸런서</a>

대부분의 서버-클라이언트와의 패킷 전송에서는 서버-클라이언트 사이에 여러 `중간서버`들이 있을 수 있다.

클라이언트가 실제로 요청한 자원을 갖고 있는 서버에 대해서 `오리진 서버`라고 한다.

중간서버의 종류로 `포워드 프록시(이하 프록시)` 와 `리버스 프록시(이하 게이트웨이)` 가 있다.

그리고 `인바운드 메세지`는 오리진 서버를 향하는 메세지를 의미하고, `아웃 바운드`는 그 반대를 의미한다.

`포워드 프록시`는 `클라이언트가 선택`한 메세지 전달 대리자를 의미한다.

그래서 클라이언트와 가까이 위치하여 캐싱, 클라이언트 암호화 등을 수행하고

`리버스 프록시`는 아웃바운드 연결에 대한 `오리진 서버 역할`을 수행하고, 수신된 메세지를 변환하여 인바운드 서버로 전달하는 중개자 역할을 수행한다.

이게 무슨말인가 하면 사실 송신자입장에서는 수신자의 포트번호를 제외했을때 특정 수신자 호스트를 아는거라기 보다는 수신자의 공인IP를 알고있다.

그래서 송신자 입장에서는 수신자가 엄밀하게 본인이 원하는 수신자는 아니지만, 그 내부에 서버로 전달해주는 매개체한테 전달하는 셈이 된다.

그래서 `리버스 프록시`는 오리진 서버들에게 더 가까이 위치하게 된다.

또한 `리버스 프록시`에서는 `포워드 프록시`와 다른 이점인 `SSL 인증관련 처리`에 있어서 비용이 적게 발생한다는 장점이 있다.

왜냐하면 각각의 클라이언트들을 묶어놓고 대표격인 `포워드 프록시`에 SSL이 있다고 생각해보면 알 수 있다. 몇개의 묶음이 될지도 모르는 것들에대해서 비용이 발생할 수 있다.

하지만 `리버스 프록시`에 SSL 인증서 관련을 처리한다면 수많은 클라이언트들은 무조건 리버스 프록시를 거쳐야 하므로, 클라이언트 마다를 생각할 필요가 없어진다.





